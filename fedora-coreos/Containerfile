ARG COREOS_VERSION="${COREOS_VERSION:-stable}"

FROM quay.io/fedora/fedora-coreos:${COREOS_VERSION}

ARG COREOS_VERSION="${COREOS_VERSION:-stable}"

# Deps for building in this image
# RUN echo "Installing dependencies" && \
#     rpm-ostree install \
#         binutils \
#         cmake \
#         python3-pip \
#         gcc-c++ \
#         gettext \
#         diffstat \
#         doxygen \
#         git \
#         patch \
#         patchutils \
#         subversion \
#         systemtap \
#         buildbot \
#         colordiff \
#         cvs \
#         cvs2cl \
#         cvsps \
#         darcs \
#         dejagnu \
#         expect \
#         gambas3-ide \
#         git-annex \
#         git-cola \
#         git2cl \
#         gitg \
#         gtranslator \
#         highlight \
#         lcov \
#         manedit \
#         meld \
#         monotone \
#         myrepos \
#         nemiver \
#         qgit \
#         quilt \
#         rapidsvn \
#         rcs \
#         robodoc \
#         scanmem \
#         subunit \
#         svn2cl \
#         tig \
#         tortoisehg \
#         translate-toolkit \
#         utrac \
#         gcc \
#         openssl-devel \
#         bzip2-devel \
#         elfutils-devel \
#         libselinux-devel \
#         elfutils-libelf-devel \
#         rpm-devel \
#         perl-devel \
#         python3-devel \
#         python3-setuptools \
#         chrpath \
#         mariadb-connector-c-devel \
#         glib2-devel \
#         gpgme-devel \
#         gnutls-devel \
#         libgcrypt-devel \
#         libuuid-devel \
#         libssh-devel \
#         hiredis-devel \
#         libxml2-devel \
#         libpcap-devel \
#         libnet-devel \
#         paho-c-devel \
#         openldap-devel \
#         radcli-devel \
#         postgresql-server \
#         postgresql-server-devel \
#         postgresql-contrib \
#         wget \
#         sshpass \
#         samba-client \
#         python3-lxml \
#         gnutls-utils \
#         perl \
#         perl-XML-Twig \
#         libmicrohttpd-devel \
#         popt-devel \
#         libunistring-devel \
#         ncurses-devel \
#         heimdal-devel \
#         bison \
#         libksba-devel \
#         nmap \
#         json-glib-devel \
#         python3-impacket \
#         python3 \
#         python3-setuptools \
#         python3-packaging \
#         python3-wrapt \
#         python3-cffi \
#         python3-psutil \
#         python3-defusedxml \
#         python3-paramiko \
#         python3-redis \
#         python3-gnupg \
#         python3-paho-mqtt \
#         redis \
#         policycoreutils-python-utils \
#         mosquitto \
#         cronie \
#         texlive-fontsize \
#         texlive-fonttable \
#         fontawesome-fonts \
#         gnupg2-smime \
#         xmlstarlet \
#         zip \
#         fakeroot \
#         dpkg \
#         mingw64-nsis \
#         mingw64-gcc \
#         wget \
#         sshpass \
#         samba-client \
#         python3-lxml \
#         gnutls-utils \
#         perl \
#         perl-XML-Twig \
#         libmicrohttpd-devel \
#         popt-devel \
#         libunistring-devel \
#         ncurses-devel \
#         heimdal-devel \
#         bison \
#         libksba-devel \
#         nmap \
#         json-glib-devel \
#         python3-impacket \
#         python3 \
#         python3-setuptools \
#         python3-packaging \
#         python3-wrapt \
#         python3-cffi \
#         python3-psutil \
#         python3-defusedxml \
#         python3-paramiko \
#         python3-redis \
#         python3-gnupg \
#         python3-paho-mqtt \
#         redis \
#         policycoreutils-python-utils

# Deps for copying from pre-built binaries
RUN echo "Installing dependencies" && \
    rpm-ostree install \
        python3 \
        python3-pip \
        python3-setuptools \
        python3-packaging \
        python3-wrapt \
        python3-cffi \
        python3-psutil \
        python3-lxml \
        python3-defusedxml \
        python3-paramiko \
        python3-redis \
        python3-gnupg \
        python3-paho-mqtt \
        postgresql-server-devel \
        postgresql-server \
        postgresql-contrib \
        policycoreutils-python-utils \
        rsync \
        mosquitto \
        redis

COPY *.sh /tmp/

COPY --from=ghcr.io/blake-lucas/greenbone-bins:latest /root /tmp/greenbone
COPY --from=ghcr.io/blake-lucas/greenbone-bins:latest /etc/openvas /etc/openvas

#RUN ls -la /tmp/greenbone && ls -la /tmp/greenbone/install/gvmd && ls -la /tmp/greenbone/install/gvm-libs

RUN chmod +x /tmp/install-greenbone-prebuilt.sh \
    && /tmp/install-greenbone-prebuilt.sh \
    && rm -rf /tmp/* \
    && ostree container commit \
    && mkdir -p /tmp /var/tmp \
    && chmod -R 1777 /tmp /var/tmp