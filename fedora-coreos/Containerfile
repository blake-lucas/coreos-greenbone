ARG COREOS_VERSION="${COREOS_VERSION:-stable}"

FROM quay.io/fedora/fedora-coreos:${COREOS_VERSION}

ARG COREOS_VERSION="${COREOS_VERSION:-stable}"

# Enable password auth for SSH
RUN rm /etc/ssh/sshd_config.d/40-disable-passwords.conf

RUN cd /tmp && \
    curl -sLO https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 && \
    mv docker-compose-linux-x86_64 /usr/bin/docker-compose && \
    chmod +x /usr/bin/docker-compose

# Download latest gdu and move to /usr/bin per the instructions at https://github.com/dundee/gdu#installation
RUN curl -L https://github.com/dundee/gdu/releases/latest/download/gdu_linux_amd64.tgz | tar xz && chmod +x gdu_linux_amd64 && mv gdu_linux_amd64 /usr/bin/gdu

# Install a few nice-to-haves
RUN rpm-ostree install \
                wget \
                htop \
                iotop \
                sysstat \
                ncdu \
                docker-compose-plugin

COPY etc /etc

COPY set-ip.sh /usr/bin/set-ip
COPY test-email.sh /usr/bin/test-email
COPY add-365-email.sh /usr/bin/add-365-email
RUN chmod +x /usr/bin/set-ip && \
    chmod +x /usr/bin/add-365-email && \
    chmod +x /usr/bin/test-email

RUN rm -rf /tmp/* && \
    systemctl enable docker.service && \
    systemctl enable greenbone.service && \
    ostree container commit && \
    mkdir -p /tmp /var/tmp && \
    chmod -R 1777 /tmp /var/tmp
